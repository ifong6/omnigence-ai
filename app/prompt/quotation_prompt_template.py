from pydantic import BaseModel
from typing import Optional

class ProjectItem(BaseModel):
    no: str
    content: str
    quantity: str
    unit: str
    unit_price: str
    subtotal: str

class QuotationInfo(BaseModel):
    client_name: str
    client_address: Optional[str] = ""
    project_name: str
    no: Optional[str] = None
    date: Optional[str] = None
    project_items: list[ProjectItem]
    total_amount: str
    currency: str

class QuotationInfoExtractOutput(BaseModel):
    quotation_info: list[QuotationInfo]  # Keep as list[QuotationInfo] for Gemini API compatibility
    messages: Optional[list[str]] = None

SYSTEM_ROLE = """
    You are an Information Extraction Agent specialized \
    in analyzing Chinese and English text \
    to extract key quotation information.
"""

TASK = """
    Step 1: Your task is to extract quotation information from the input text.

    For each quotation, extract:
    1. Customer (客戶) - Look for terms containing "有限公司", "公司", "limited", or "LLC".
    2. Project Name (項目名稱) - For SINGLE sets, project_name and content are the SAME.
      For MULTIPLE sets, project_name is the MAIN project name, and content belongs to each line item.
    3. Line items - A list of line items, each with a cost in MOP.
"""

PATTERN_RULES = """
  step 2: Rules for identifying multiple quotations:
  - Data follows a repeating 3-item pattern: company - project - cost.
  - Patterns may be separated by newlines OR spaces.

  Pattern Recognition Rules:
  1. Customer:
    - Contains "有限公司", "公司", "limited", "LLC", or "company".
    - Usually first in each quotation.
  2. Project Description:
    - Between company name and cost.
    - Describes technical work/scope.
    - In MULTIPLE sets: this is the overarching project name.
  3. Line Items:
    - Must include price in MOP.
    - Default unit: "Lot" if unspecified.
    - IMPORTANT: Auto-generate "no" field sequentially (1, 2, 3...) for each line item.
      Do NOT extract "no" from user input. Always start from 1 for each quotation.
"""

OUTPUT_RULES = """
    step 3: Output format, MUST use **QuotationInfoExtractOutput** schema: 
    ```json
    {{
      "quotation_info": [
        {{
          "client_name": "<client_name>",
          "client_address": "<client_address>",
          "project_name": "<project_name>",
          "no": "<no>",
          "date": "<date>",
          "project_items": [
            {{
              "no": "<auto-generated: 1, 2, 3... for each line item>",
              "content": "<content>",
              "quantity": "<quantity>",
              "unit": "<unit>",
              "unit_price": "<unit_price>",
              "subtotal": "<unit_price * quantity>"
            }}
          ],
          "total_amount": "<the sum of all subtotal in project_items>",
          "currency": "<currency>"
        }}
      ],
      "messages": ["<your reasoning and thought process of your quotation information extraction result>"]
    }}
"""

EXAMPLES = """
    ------------------------------
    Example 1: Newline-separated and single quotation
    
    Input:
    長聯建築工程有限公司
    A3連接橋D匝道箱樑木模板支撐架計算
    7000MOP

    Output:
    ```json
    {{
      "quotation_info": [
        {{
        "client_name": "長聯建築工程有限公司",
        "project_name": "A3連接橋D匝道箱樑木模板支撐架計算",
        "project_items": [
          {{
            "no": "1",
            "content": "A3連接橋D匝道箱樑木模板支撐架計算",
            "quantity": "1",
            "unit": "Lot",
            "unit_price": "7000",
            "subtotal": "7000"
          }}
          ],
        "total_amount": "7000",
        "currency": "MOP"
        }}
      ],
      "messages": ["I have extracted the quotation information from the input text."]
    }}
    
  ------------------------------
    Example 2: Multiple line items and multiple quotations
    Input:
    金輝A8項目模板計算
    樑模板計算 5000 MOP
    牆體模板計算 5000 MOP

    Output:
    ```json
    {{
      "quotation_info": [
        {{
          "client_name": "金輝",
          "project_name": "金輝A8項目模板計算",
          "project_items": [
            {{
              "no": "1",
              "content": "樑模板計算",
              "quantity": "1",
              "unit": "Lot",
              "unit_price": "5000",
              "subtotal": "5000"
            }},
            {{
              "no": "2",
              "content": "牆體模板計算",
              "quantity": "1",
              "unit": "Lot",
              "unit_price": "5000",
              "subtotal": "5000"
            }}
          ],
          "total_amount": "10000",
          "currency": "MOP"
        }},
        {{
          "client_name": "Citywide Development Ltd",
          "project_name": "Harbor Bridge Foundation Design",
          "project_items": [
            {{
              "no": "1",
              "content": "Structural Analysis & Design",
              "quantity": "120",
              "unit": "Hours",
              "unit_price": "180",
              "subtotal": "21600"
            }},
            {{
              "no": "2",
              "content": "Geotechnical Investigation",
              "quantity": "45",
              "unit": "Hours",
              "unit_price": "200",
              "subtotal": "9000"
            }},
            {{
              "no": "3",
              "content": "Foundation Pile Design",
              "quantity": "80",
              "unit": "Hours",
              "unit_price": "190",
              "subtotal": "15200"
            }},
            {{
              "no": "4",
              "content": "Engineering Drawings Package",
              "quantity": "1",
              "unit": "Set",
              "unit_price": "8500",
              "subtotal": "8500"
            }}
          ],
          "total_amount": "54300",
          "currency": "HKD"
        }}
      ],
      "messages": ["I have extracted multiple quotations with their respective line items from the input text."]
    }}
"""

  # Build full prompt
EXTRACT_QUOTATION_PROMPT_TEMPLATE= (
    SYSTEM_ROLE +
    TASK +
    PATTERN_RULES +
    OUTPUT_RULES +
    EXAMPLES +
    "\n\nUser Input:\n{user_input}"
)