<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>INVOICE — CHUNPAK ENGINEERING CONSULTANCY, LTD.</title>
    <!-- Fonts: Inter (Latin) + Noto Sans TC (Traditional Chinese) -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+TC:wght@400;500;700;900&display=swap"
      rel="stylesheet"
    />
    <!-- Promise polyfill (safe in older browsers) -->
    <script src="es6-promise.auto.min.js"></script>
    <!-- All-in-one bundle (includes html2canvas + jsPDF) -->
    <script src="html2pdf.bundle.min.js"></script>
    <style>
      :root {
        --bg: #f7f7f8;
        --card: #ffffff;
        --ink: #0f172a;
        --muted: #64748b;
        --border: #e5e7eb;
        --brand: #111827;
        --accent: #0ea5e9;
        --row: #fafafa;
        --danger: #ef4444;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        margin: 0;
        padding: 0;
        background: var(--bg);
        color: var(--ink);
        font: 14px/1.6 "Inter", "Noto Sans TC", -apple-system,
          BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial,
          "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      }
      .container {
        max-width: 980px;
        margin: 40px auto;
        padding: 24px;
      }
      .card {
        background: var(--card);
        border-radius: 16px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.06);
        overflow: hidden;
        border: 1px solid var(--border);
      }
      .header {
        padding: 28px 28px 8px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 16px;
        flex-wrap: wrap;
      }
      .brand {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .brand h1 {
        margin: 0;
        font-size: 22px;
        letter-spacing: 1.2px;
        font-family: "Noto Sans TC", Inter, sans-serif;
      }
      .brand .en {
        font-weight: 600;
        font-size: 12px;
        color: var(--muted);
        letter-spacing: 0.6px;
      }
      .meta {
        display: grid;
        gap: 6px;
        font-size: 13px;
        min-width: 280px;
      }
      .meta div {
        display: flex;
        justify-content: space-between;
        gap: 12px;
      }
      .pill {
        display: inline-block;
        border: 1px solid var(--border);
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        color: var(--muted);
        width: max-content;
      }
      .title {
        padding: 14px 28px 0;
        font-size: 24px;
        font-weight: 800;
        text-align: center;
        letter-spacing: 1px;
      }
      .subtitle {
        text-align: center;
        color: var(--muted);
        margin-top: 0;
        margin-bottom: 12px;
        font-size: 12px;
      }
      .section {
        padding: 20px 28px;
      }
      .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }
      .kv {
        display: grid;
        gap: 4px;
      }
      .kv .label {
        color: var(--muted);
        font-size: 12px;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: #111827;
        color: #fff;
        border-radius: 999px;
        padding: 6px 12px;
        font-weight: 700;
        letter-spacing: 0.5px;
        font-size: 12px;
      }
      .badge .sub {
        opacity: 0.9;
        font-weight: 600;
      }
      table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        border: 1px solid var(--border);
        border-radius: 12px;
        overflow: hidden;
      }
      thead th {
        background: var(--row);
        color: var(--muted);
        font-weight: 700;
        text-align: left;
        font-size: 12px;
        padding: 12px;
        border-bottom: 1px solid var(--border);
      }
      tbody td {
        padding: 12px;
        border-bottom: 1px solid var(--border);
        vertical-align: middle;
      }
      tbody tr:last-child td {
        border-bottom: none;
      }
      .num {
        text-align: center;
        white-space: nowrap;
      }
      .right {
        text-align: right;
        white-space: nowrap;
      }
      .muted {
        color: var(--muted);
      }
      .btns {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin: 10px 0 16px;
      }
      .btn {
        appearance: none;
        border: 1px solid var(--border);
        background: #fff;
        border-radius: 10px;
        padding: 8px 12px;
        cursor: pointer;
        font-weight: 600;
      }
      .btn.primary {
        background: #0ea5e9;
        color: #fff;
        border-color: #0ea5e9;
      }
      .btn.danger {
        border-color: var(--danger);
        color: var(--danger);
        background: #fff;
      }
      .inputs {
        width: 100%;
        display: grid;
        grid-template-columns: 72px 1fr 110px 100px 140px 140px 40px;
        gap: 0;
      }
      .inputs input,
      .inputs select {
        width: 100%;
        padding: 10px 8px;
        border: 1px solid var(--border);
        outline: none;
      }
      .inputs input {
        border-width: 0 0 1px 0;
      }
      .total {
        display: flex;
        justify-content: flex-end;
        padding: 16px 0 0;
      }
      .total-card {
        min-width: 340px;
        border: 1px solid var(--border);
        border-radius: 12px;
        overflow: hidden;
      }
      .total-row {
        display: flex;
        justify-content: space-between;
        padding: 12px 16px;
        font-weight: 600;
        border-bottom: 1px solid var(--border);
      }
      .total-row:last-child {
        border-bottom: none;
        background: #fafafa;
        font-size: 18px;
      }
      .footer {
        padding: 22px 28px 28px;
        color: var(--muted);
        font-size: 12px;
      }
      .bank {
        margin-top: 8px;
        padding: 12px 16px;
        border: 1px dashed var(--border);
        border-radius: 10px;
        background: #fcfcfd;
      }
      @media (max-width: 860px) {
        .inputs {
          grid-template-columns: 52px 1fr 90px 80px 120px 120px 36px;
        }
      }
      @media (max-width: 680px) {
        .grid-2 {
          grid-template-columns: 1fr;
        }
        .inputs {
          grid-template-columns: 1fr;
        }
        .right,
        .num {
          text-align: left;
        }
      }
      @media print {
        html,
        body {
          background: #fff;
        }
        .container {
          margin: 0;
          padding: 0;
          max-width: none;
        }
        .card {
          border: none;
          box-shadow: none;
          border-radius: 0;
        }
        .btns {
          display: none !important;
        }
      }
      /* Compact input visuals */
      input[type="number"]::-webkit-outer-spin-button,
      input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      input[type="number"] {
        -moz-appearance: textfield;
      }
      /* Optional: subtle contenteditable focus style */
      [contenteditable="true"] { outline: 2px dashed transparent; border-radius: 6px; }
      [contenteditable="true"]:focus { outline-color: #dbeafe; background: #f8fafc; }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="card">
        <div class="header">
          <div class="brand">
            <h1>浚珀工程顧問有限公司</h1>
            <div class="en">CHUNPAK ENGINEERING CONSULTANCY, LTD.</div>
            <span class="pill">澳門 • Engineering Consultancy</span>
          </div>
          <div class="meta">
            <div>
              <span>[編號 / Invoice No.]</span>
              <!-- Make header fields inline-editable -->
              <strong id="No" contenteditable="true">[INV]-JCP-YY-NO-VER</strong>
            </div>
            <div>
              <span>日期 / Date</span>
              <strong id="Date" contenteditable="true">{{current_date_str}}</strong>
            </div>
          </div>
        </div>

        <div class="title">發票單 INVOICE SHEET</div>
        <div class="subtitle">— Official invoice —</div>

        <div class="section grid-2">
          <div class="kv">
            <div class="label">客戶</div>
            <div><strong id="customerName" contenteditable="true">(provided by the user otherwise unknown)</strong></div>
          </div>
          <div class="kv">
            <div class="label">地址</div>
            <div><span class="muted" id="customerAddr" contenteditable="true">(provided by the user otherwise unknown)</span></div>
          </div>
        </div>

        <div class="section">
          <div class="badge">
            項目名稱 / Project Name
            <span class="sub" id="projectName" contenteditable="true">(example: A3連接橋D匝道箱樑木模板支撐架計算)</span>
          </div>
        </div>
        <div class="section">
          <table id="itemsTable">
            <thead>
              <tr>
                <th class="num" style="width: 60px">序號 / No.</th>
                <th style="width: 400px">內容 / Description</th>
                <th class="num" style="width: 80px">數量 / Quantity</th>
                <th class="num" style="width: 80px">單位 / Unit</th>
                <th class="right" style="width: 120px">單價（澳門元） / Unit Price (MOP)</th>
                <th class="right" style="width: 120px">小計（澳門元） / Subtotal (MOP)</th>
                <th style="width: 40px"></th>
              </tr>
            </thead>
            <tbody id="tbody">
              <!-- Dynamic rows go here -->
            </tbody>
          </table>

          <!-- Toolbar: add/remove/export -->
          <div class="btns">
            <button class="btn primary" id="btnAdd">＋ Add item</button>
            <button class="btn" id="btnClear">Clear all</button>
            <button class="btn" id="btnExport">Export PDF</button>
          </div>
        </div>

        <div class="section">
          <div class="total">
            <div class="total-card">
              <div class="total-row">
                <span>合計 Total</span>
                <span id="grandtotal"><strong>MOP $0.00</strong></span>
              </div>
            </div>
          </div>
        </div>

        <div class="footer">
          <p>
            備註：<br />
            1.本發票不包括任何文件運輸及提交工作;<br />
            2.本發票不包括文件打印服務;<br />
            3.如對本發票有何問題請與我司聯繫。
          </p>
        </div>
      </div>
    </div>

    <script>
      // ====== helpers ======
      const tbody = document.getElementById("tbody");
      const fmt = (n) =>
        "MOP $" +
        (Number(n) || 0).toLocaleString(undefined, {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        });

      function clampNonNegativeNumber(input, step = 1) {
        const v = parseFloat(input.value);
        if (isNaN(v) || v < 0) input.value = "0";
      }

      // ====== row CRUD ======
      function addRow(data = { no: "", desc: "", qty: 1, unit: "Lot", price: 0 }) {
        const i = tbody.children.length + 1;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="num">
            <input type="number" min="1" value="${i}"
              oninput="recalc()" style="width:64px;text-align:center;border:none;background:transparent">
          </td>
          <td>
            <input type="text" value="${data.desc || ""}"
              oninput="recalc()" placeholder="內容 / Description"
              style="width:100%;border:none;background:transparent">
          </td>
          <td class="num">
            <input type="number" min="0" step="1" value="${data.qty ?? 1}"
              oninput="clampNonNegativeNumber(this);recalc()"
              style="width:90px;text-align:center;border:none;background:transparent">
          </td>
          <td class="num">
            <select onchange="recalc()" style="width:90px;border:none;background:transparent">
              ${["Lot", "件", "套", "m", "m²", "hr"]
                .map((u) => `<option ${u === (data.unit || "Lot") ? "selected" : ""}>${u}</option>`)
                .join("")}
            </select>
          </td>
          <td class="right">
            <input type="number" min="0" step="0.01" value="${data.price ?? 0}"
              oninput="clampNonNegativeNumber(this, 0.01);recalc()"
              style="width:120px;text-align:right;border:none;background:transparent">
          </td>
          <td class="right"><span class="line-subtotal">MOP $0.00</span></td>
          <td class="num">
            <button class="btn danger" style="padding:4px 8px" onclick="removeRow(this)">✕</button>
          </td>
        `;
        tbody.appendChild(tr);
        recalc();
      }

      function removeRow(btn) {
        const tr = btn.closest("tr");
        tr.remove();
        // re-number serials
        [...tbody.rows].forEach((row, idx) => {
          const serialInput = row.cells[0].querySelector("input");
          if (serialInput) serialInput.value = idx + 1;
        });
        recalc();
      }

      function clearRows() {
        tbody.innerHTML = "";
        recalc();
      }

      // ====== totals ======
      function recalc() {
        let subtotal = 0;
        [...tbody.rows].forEach((row) => {
          const qty = parseFloat(row.cells[2].querySelector("input")?.value || 0);
          const price = parseFloat(row.cells[4].querySelector("input")?.value || 0);
          const line = (isFinite(qty) ? qty : 0) * (isFinite(price) ? price : 0);
          subtotal += line;
          row.cells[5].querySelector(".line-subtotal").textContent = fmt(line);
        });
        document.getElementById("grandtotal").innerHTML = "<strong>" + fmt(subtotal) + "</strong>";
      }

      // ====== toolbar actions ======
      document.getElementById("btnAdd")?.addEventListener("click", () => addRow());
      document.getElementById("btnClear")?.addEventListener("click", () => clearRows());
      document.getElementById("btnExport")?.addEventListener("click", async () => {
        const blob = await savePDFToFile();
        // Trigger a save in-browser:
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = (document.getElementById("No")?.textContent || "invoice") + ".pdf";
        a.click();
        URL.revokeObjectURL(url);
      });

      // ====== initial seed ======
      addRow({
        desc: "A3連接橋D匝道箱樑木模板支撐架計算",
        qty: 1,
        unit: "Lot",
        price: 7000,
      });

      // ====== PDF export (uses displayed invoice No) ======
      async function savePDFToFile() {
        const element = document.querySelector(".card");
        const opt = {
          margin: 10,
          filename: (document.getElementById("No")?.textContent || "invoice") + ".pdf",
          image: { type: "jpeg", quality: 0.98 },
          html2canvas: { scale: 2, useCORS: true, letterRendering: true },
          jsPDF: { unit: "mm", format: "a4", orientation: "portrait" },
        };

        const btns = document.querySelector(".btns");
        if (btns) btns.style.display = "none";
        try {
          // return Blob for programmatic use
          return await html2pdf().set(opt).from(element).output("blob");
        } finally {
          if (btns) btns.style.display = "flex";
        }
      }
    </script>
  </body>
</html>
